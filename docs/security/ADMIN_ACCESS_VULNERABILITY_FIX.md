# Security Fix: Admin Access Vulnerability

## Incident Date: January 28, 2025

## Summary

A critical security vulnerability was discovered where any user with an `@somos.tech` email domain could gain unauthorized admin access to the SOMOS.tech platform.

## Affected User

- **Email**: `ai-dev43@somos.tech`
- **Discovery**: User was found in admin portal without explicit authorization
- **Status**: User has been removed from admin-users container

## Vulnerabilities Fixed

### 1. Auto-Registration of @somos.tech Users (CRITICAL)
**File**: `apps/api/functions/GetUserRoles.js`

**Before (Vulnerable)**:
```javascript
// If user has @somos.tech email and not in container, add them
if (email.endsWith('@somos.tech')) {
    const userId = identityClaim || `admin-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    await container.items.create({
        id: userId,
        email: email,
        roles: ['admin', 'authenticated'],
        createdAt: new Date().toISOString()
    });
    roles.push('admin');
}
```

**After (Fixed)**:
```javascript
// User must be explicitly added to admin-users container
// No auto-registration for @somos.tech users
context.log(`User ${email} not found in admin-users container and will not receive admin role`);
```

### 2. Database Error Fallback (HIGH)
**File**: `apps/api/functions/GetUserRoles.js`

**Before (Vulnerable)**:
```javascript
} catch (dbError) {
    context.log.error('Database error:', dbError.message);
    // Fallback: grant admin to @somos.tech emails if DB is unavailable
    if (email.endsWith('@somos.tech')) {
        roles.push('admin');
    }
}
```

**After (Fixed)**:
```javascript
} catch (dbError) {
    context.log.error('Database error:', dbError.message);
    // Security: Do NOT grant admin role on database errors
    // User must be explicitly verified in admin-users container
    context.log.warn(`Cannot verify admin status for ${email} due to database error - denying admin access`);
}
```

### 3. Frontend Fallback (MEDIUM)
**File**: `apps/web/src/hooks/useAuth.ts`

**Before (Vulnerable)**:
```javascript
} catch (error) {
    console.error('Failed to check admin status:', error);
    // Fallback: check if email ends with @somos.tech
    return email.endsWith('@somos.tech');
}
```

**After (Fixed)**:
```javascript
} catch (error) {
    console.error('Failed to check admin status:', error);
    // Security: Do not grant admin access if API check fails
    return false;
}
```

## Root Cause Analysis

The original implementation was designed for convenience during development, allowing any `@somos.tech` email holder to automatically become an admin. This design:

1. **Violated least privilege principle** - Users gained elevated access without explicit authorization
2. **Created an attack surface** - Anyone who could register with a `@somos.tech` email could gain admin access
3. **Had no audit trail** - Auto-registered admins weren't tracked or approved by existing admins

## Remediation Steps Taken

1. ✅ Identified all three vulnerability points in the codebase
2. ✅ Applied security patches to `GetUserRoles.js` and `useAuth.ts`
3. ✅ Committed and pushed changes (commit `ca5b7d5`)
4. ✅ Removed unauthorized user `ai-dev43@somos.tech` from admin-users container
5. ✅ Verified only authorized admins remain:
   - `jcruz@somos.tech`
   - `fserna@somos.tech`

## New Admin Onboarding Process

Going forward, new admin users **must** be explicitly added to the `admin-users` container in Cosmos DB. This can be done:

1. **Via existing admin scripts**: Use `scripts/add-admin-user.ps1` or `scripts/add-first-admin.js`
2. **Via Azure Portal**: Directly add a document to the `admin-users` container
3. **Via Admin Portal**: (Future) Implement admin user management UI

### Required Document Structure

```json
{
    "id": "admin-<timestamp>-<random>",
    "email": "user@somos.tech",
    "roles": ["admin", "authenticated"],
    "createdAt": "<ISO date>",
    "addedBy": "<admin email who approved>"
}
```

## Security Recommendations

1. **Implement admin invitation workflow** - Require existing admin approval for new admins
2. **Add audit logging** - Track all admin access and actions
3. **Implement session monitoring** - Alert on unusual admin activity
4. **Regular access reviews** - Periodically verify admin list is accurate
5. **MFA enforcement** - Require multi-factor authentication for admin access

## Deployment Status

- **Commit**: `ca5b7d5`
- **Branch**: `main`
- **Status**: Pushed, awaiting Azure Static Web Apps automatic deployment
